<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Предзаказ — Сотрудник</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header class="app-header py-3">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <h1 class="h3 mb-1 text-white">ПАНЕЛЬ СОТРУДНИКА</h1>
          <div class="text-white-50">Управление статусами заказов</div>
        </div>
        <div class="badge bg-light text-dark">Staff</div>
      </div>
    </div>
  </header>

  <main class="container my-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body d-flex flex-wrap gap-2 align-items-center">
        <span class="text-muted small">Фильтр статуса:</span>
        <button class="btn btn-outline-secondary btn-sm filter-btn active" data-status="ALL">ALL</button>
        <button class="btn btn-outline-secondary btn-sm filter-btn" data-status="CREATED">CREATED</button>
        <button class="btn btn-outline-secondary btn-sm filter-btn" data-status="ACCEPTED">ACCEPTED</button>
        <button class="btn btn-outline-secondary btn-sm filter-btn" data-status="COOKING">COOKING</button>
        <button class="btn btn-outline-secondary btn-sm filter-btn" data-status="READY">READY</button>
        <button class="btn btn-outline-secondary btn-sm filter-btn" data-status="ISSUED">ISSUED</button>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h5 mb-3">Список заказов</h2>
        <div id="orders" class="vstack gap-2"></div>
      </div>
    </div>
  </main>

  <script>
    let activeStatus = 'ALL';

    function renderOrders(orders) {
      const list = document.getElementById('orders');
      list.innerHTML = '';
      orders
        .filter(o => activeStatus === 'ALL' || o.status === activeStatus)
        .forEach(o => {
          const el = document.createElement('div');
          el.className = 'border rounded p-3 d-flex justify-content-between align-items-center';
          el.innerHTML = `
            <div>
              <div class="fw-semibold">Заказ №${o.id}</div>
              <div class="text-muted small">Статус: ${o.status} • ${o.totalAmount} ₽</div>
              <div class="small mt-1">${(o.items || []).map(it => `${it.dishName || ('#' + it.dishId)} x${it.qty}`).join(', ')}</div>
            </div>
            <select class="form-select form-select-sm w-auto" onchange="updateStatus(${o.id}, this.value)">
              <option value="CREATED">CREATED</option>
              <option value="ACCEPTED">ACCEPTED</option>
              <option value="COOKING">COOKING</option>
              <option value="READY">READY</option>
              <option value="ISSUED">ISSUED</option>
            </select>`;
          const select = el.querySelector('select');
          select.value = o.status;
          list.appendChild(el);
        });
    }

    async function loadOrders() {
      const res = await fetch('/api/orders');
      const orders = await res.json();
      renderOrders(orders);
    }

    async function updateStatus(id, status) {
      await fetch(`/api/orders/${id}/status?status=${status}`, { method: 'PATCH' });
      loadOrders();
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeStatus = btn.dataset.status;
        loadOrders();
      });
    });

    loadOrders();
    setInterval(loadOrders, 5000);
  </script>
</body>
</html>
