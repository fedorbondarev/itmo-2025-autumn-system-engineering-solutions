<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Предзаказ — Клиент</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header class="app-header py-3">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <h1 class="h3 mb-1 text-white">FASTFOOD PREORDER</h1>
          <div class="text-white-50">Быстрое оформление без очередей</div>
        </div>
        <div class="badge bg-light text-dark">Клиент</div>
      </div>
    </div>
  </header>

  <nav class="app-nav py-2">
    <div class="container">
      <div class="d-flex gap-3 small text-uppercase">
        <span class="fw-semibold">Меню</span>
        <span class="text-muted">Корзина</span>
        <span class="text-muted">Статус</span>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
              <div class="flex-grow-1">
                <input id="searchInput" class="form-control" placeholder="Поиск блюда..." />
              </div>
              <div class="btn-group" role="group">
                <button class="btn btn-outline-secondary btn-sm filter-btn active" data-category="all">Все</button>
                <button class="btn btn-outline-secondary btn-sm filter-btn" data-category="бургеры">Бургеры</button>
                <button class="btn btn-outline-secondary btn-sm filter-btn" data-category="снэки">Снэки</button>
                <button class="btn btn-outline-secondary btn-sm filter-btn" data-category="напитки">Напитки</button>
              </div>
            </div>
            <h2 class="h5 mb-3">Список блюд</h2>
            <div id="menu" class="vstack gap-2"></div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <h2 class="h5 mb-3">Корзина</h2>
            <div id="cart" class="vstack gap-2"></div>
            <div class="d-flex justify-content-between mt-3 fw-semibold">
              <span>Итого</span>
              <span id="cartTotal">0 ₽</span>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <label class="form-label">Время выдачи (ISO)</label>
            <input id="requestedTime" class="form-control mb-3" type="text" value="2026-01-27T13:30:00" />
            <button id="submitOrder" class="btn btn-success w-100">Оформить заказ</button>
            <div id="orderResult" class="alert alert-light mt-3 mb-0 d-none"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const userId = 1;

    let allDishes = [];
    let activeCategory = 'all';

    function categoryFromName(name) {
      const n = name.toLowerCase();
      if (n.includes('бургер')) return 'бургеры';
      if (n.includes('кола') || n.includes('напит')) return 'напитки';
      return 'снэки';
    }

    function renderMenu() {
      const menu = document.getElementById('menu');
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      menu.innerHTML = '';
      allDishes
        .filter(d => (activeCategory === 'all' || categoryFromName(d.name) === activeCategory))
        .filter(d => d.name.toLowerCase().includes(q))
        .forEach(d => {
          const el = document.createElement('div');
          el.className = 'card border-0 shadow-sm';
          el.innerHTML = `
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">${d.name}</div>
                <div class="text-muted small">${d.description || ''}</div>
              </div>
              <div class="text-end">
                <div class="fw-semibold mb-2">${d.price} ₽</div>
                <button class="btn btn-primary btn-sm" onclick="addToCart(${d.id})">Добавить</button>
              </div>
            </div>`;
          menu.appendChild(el);
        });
    }

    async function loadMenu() {
      const res = await fetch('/api/dishes');
      allDishes = await res.json();
      renderMenu();
    }

    async function loadCart() {
      const res = await fetch(`/api/cart/${userId}`);
      const cart = await res.json();
      const cartEl = document.getElementById('cart');
      let total = 0;
      cartEl.innerHTML = '';
      cart.items.forEach(i => {
        const el = document.createElement('div');
        el.className = 'd-flex justify-content-between align-items-center border rounded p-2';
        const name = i.dishName ? i.dishName : `Блюдо #${i.dishId}`;
        el.innerHTML = `
          <div>${name} — ${i.qty} шт.</div>
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" onclick="updateCart(${i.dishId}, ${i.qty - 1})">-</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="updateCart(${i.dishId}, ${i.qty + 1})">+</button>
          </div>`;
        cartEl.appendChild(el);
        total += i.qty;
      });
      document.getElementById('cartTotal').textContent = `${total} шт.`;
    }

    async function addToCart(dishId) {
      await fetch(`/api/cart/${userId}/items?dishId=${dishId}&qty=1`, { method: 'POST' });
      loadCart();
    }

    async function updateCart(dishId, qty) {
      await fetch(`/api/cart/${userId}/items?dishId=${dishId}&qty=${qty}`, { method: 'PUT' });
      loadCart();
    }

    document.getElementById('submitOrder').addEventListener('click', async () => {
      const requestedTime = document.getElementById('requestedTime').value;
      const res = await fetch(`/api/orders?userId=${userId}&requestedTime=${encodeURIComponent(requestedTime)}`, { method: 'POST' });
      const order = await res.json();
      const box = document.getElementById('orderResult');
      box.classList.remove('d-none');
      box.textContent = `Заказ №${order.id} создан. Статус: ${order.status}`;
      loadCart();
    });

    document.getElementById('searchInput').addEventListener('input', renderMenu);
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeCategory = btn.dataset.category;
        renderMenu();
      });
    });

    loadMenu();
    loadCart();
  </script>
</body>
</html>
